@inherits StateComponentBase
@inject IHttpContextAccessor ContextAccessor
@using System.IO

@if (this.UserState.GroupedResources is not null) // user has access to catalog
{
    <div class="available-groups">

        <MatTextField @bind-Value="this.UserState.SearchString"
                      OnInput="e => this.UserState.SearchString = e.Value.ToString()"
                      Label="Search"
                      Icon="@_searchIcon"
                      IconOnClick="@(() => this.UserState.SearchString = "")"
                      IconTrailing="true">
        </MatTextField>

        <div class="available-groups-list">
            @foreach (var entry in this.UserState.GroupedResources.OrderBy(entry => entry.Key).Skip(this.GroupPage * this.GroupPageSize).Take(this.GroupPageSize))
            {
                <div @onclick="() => this.UserState.GroupedResourcesEntry = entry"
                     class="group-entry @(this.UserState.GroupedResourcesEntry.Equals(entry) ? "selected" : "")">
                    <span class="group-entry-name">@entry.Key</span>
                    <span class="group-entry-count">@entry.Value.Count</span>
                </div>
            }
        </div>

        <Paginator Length="this.UserState.GroupedResources.Count" PageSize="this.GroupPageSize" @bind-Page="this.GroupPage"></Paginator>
    </div>

    <div class="available-resources">
        @if (this.UserState.GroupedResourcesEntry.Value is not null)
        {
            <div>
                @foreach (var resource in this.UserState.GroupedResourcesEntry.Value.Skip(this.ResourcePage * this.ResourcePageSize).Take(this.ResourcePageSize))
                {
                    <ResourceExpander Resource="@resource" />
                }
            </div>

            <Paginator Length="this.UserState.GroupedResourcesEntry.Value.Count" PageSize="this.ResourcePageSize" @bind-Page="this.ResourcePage"></Paginator>
        }
    </div>
}
else if (this.UserState.CatalogContainer is not null) // user has no access to catalog
{
<div class="catalog-no-access">
    @if (this.ContextAccessor.HttpContext.User.Identity.IsAuthenticated)
    {
        var enumeratonOptions = new System.IO.EnumerationOptions() { MatchCasing = System.IO.MatchCasing.CaseInsensitive };

        @if (this.DatabaseManager.TryReadFirstAttachment(this.UserState.CatalogContainer.Id, "LICENSE.md", enumeratonOptions, out var attachment))
        {
            try
            {
                <MarkdownRenderer MarkdownString="@(new StreamReader(attachment).ReadToEnd())" />
                <MatButton OnClick="this.AcceptLicenseAsync" Raised="true">Accept</MatButton>
            }
            finally
            {
                attachment.Dispose();
            }
        }
        else
        {
            @if (!string.IsNullOrWhiteSpace(this.UserState.CatalogContainer.CatalogMetadata.Contact))
            {
                <span>You do not have access to this catalog. Please contact @(this.UserState.CatalogContainer.CatalogMetadata.Contact) to request permission.</span>
            }
            else
            {
                <span>You do not have access to this catalog.</span>
            }
        }
    }
    else
    {
        <span>You are not logged in. Access to catalog denied.</span>
    }
</div>
}